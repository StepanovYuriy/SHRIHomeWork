# SHRIHOMEWORKIII-907 - Workers

## Общие пояснения к работе

Все файлы, относящиеся к этому домашнему заданию, находятся в папке [`/10-785-TypeScript`](../10-785-TypeScript)

[Инструкция по запуску приложения](../10-785-TypeScript/README.md)

## Стратегия кеширования 

Для кэширования была выбрана стратегия 
[__"Stale-while-revalidate"__](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook#stale-while-revalidate)
([__"Cache and update"__](https://serviceworke.rs/strategy-cache-and-update_demo.html))

В разных источниках она называется по-разному, но лучше всего суть передаёт схема ниже или пример демо выше

![](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/images/cm-stale-while-revalidate.png)

__Почему эта стратегия:__

Я считаю, что раз это стратегия кэширования, то должны в приоритете выдаваться кешированные данные.
Извечная проблема устаревания кэша уходит после следующей перезагрузки страницы, благодаря обновлению кэша после каждого запроса.

Конечно, как и любой другой стратегии у этой есть свои минусы, но лично мне такая стратегия показалась наиболее подходящей

## Create React App и Workbox

В оригинальном приложении [Create React App](https://create-react-app.dev/docs/making-a-progressive-web-app/), которое я использовал для разворачивания инфраструктуры,
используется готовое решение для создания и подключения сервис воркеров.

Стерев 2 символа в строчке `serviceWorker.unregister()` и согласившись [со стратегией по умолчанию](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/#cache-falling-back-to-network) 
можно было бы завершить домашнюю работу. Однако как же можно было не пописать свои велосипеды :)

Главная проблема, с которой я больше всего намаялся - это вырезать или заменить стандартную генерацию файла server-worker.js.
Файл сервис воркера генерируется с помощью плагина вебпака для [Workbox'а](https://developers.google.com/web/tools/workbox) (new WorkboxWebpackPlugin.GenerateSW).

Вариантов было несколько:
1. Настроить workbox своей конфигурацией. 
Но разработчики CRA такой возможности не предоставили (либо я не нашёл). 
2. `npm run eject` и убрать workbox руками. 
Можно, но хотелось сохранить CRA и найти другое решение
3. Сложить файл с сервис воркером в папку [public](.\public) и назвать его по-другому. 
Рабочее решение. Но перфекционизм, исходный код лежащий в неочевидной папке и самое главное два файла сервис воркеров в папке с бандлом - заставили искать другое решение.
4. Заставить workbox сделать то, что он должен был сделать, но только так, как нужно мне.

Что в итоге получилось:

С помощью консольной утилиты workbox injectManifest по файлу конфигурации после сборки бандлов повторно собирается сервис воркер.
Таким образом workbox больше не участвует в работе сервис воркеров.
Единственное, что нельзя убрать от Workbox - WB_MANIFEST. 
Необходимо упоминание в коде self.__WB_MANIFEST, куда при сборке будут записаны все файлы находящие в папке build.
Но это я решил использовать, т.к. всё равно уже есть готовый список файлов для предварительного кеширования.

Будет очень круто, если эта ситуация будет освещена при разборе ДЗ.
Если есть варианты, как можно это сделать проще - буду рад узнать :)

___

Общий файл [README.md](../README.md) для всех домашних работ.
